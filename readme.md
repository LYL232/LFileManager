# LYL232FileManager: LYL232的文件管理程序

一个实现简单的文件管理功能的程序。主要管理多物理位置不常变的复杂目录结构，可以快速、自动化地将一个物理位置的目录同步到其他物理位置，并查找重复的数据。

本程序对数据的删除持保守态度，需要删除文件时会逐条询问。

目前的功能有：

1. 文件查重：在所有受管理的文件夹中查询大小、MD5值重复的文件记录并选择保留。
2. 不同位置的文件夹内容管理。
3. 本程序所使用数据库的备份，转为文本文件、从文本文件中恢复出数据库。
4. 给受管理的文件夹下的文件打标签，以便之后根据关键字搜索相关文件（计划实现）。

## 注意事项

1. 常变文件不应该受本程序管理，若有被追踪的目录下的文件被改变或删除，应该重新刷新整个所属被追踪的文件夹。
2. 本文件检查两个文件是否相同的步骤：
   1. 判断大小是否一致。一致则下一步，否则判断为不一致。
   3. 判断md5sum是否一致。一致则判断两个文件相同。

## 程序安装

- Docker 或 mysql
- Python 3.9

### 安装Python 依赖库

推荐使用conda创建专用Python环境:

```bash
conda create -n lyl232fm python=3.9
```

1. 安装Python安装包：在本项目根目录下：

   ```bash
   pip install -r requirements.txt
   ```

### 初始化

#### 使用Docker建立数据库（或者有其他部署mysql的方式可忽略此步骤）

参考链接：https://www.cnblogs.com/sablier/p/11605606.html

1. 拉取数据库镜像

   ```bash
   docker pull mysql:8.0
   ```

2. 建立MySQL的新容器：(端口号和密码可自行选择)

   ```bash
   docker run -p 3306:3306 --name lyl232fm_mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:8.0
   ```

   可以建立目录映射：(宿主机目录和密码123456可以自定义)

   ```bash
   docker run -p 3306:3306 --name lyl232fm_mysql \
   -v 宿主机目录/etc/mysql:/etc/mysql \
   -v 宿主机目录/var/lib/mysql:/var/lib/mysql \
   -v 宿主机目录/var/lib/mysql-files:/var/lib/mysql-files \
   -e MYSQL_ROOT_PASSWORD=123456 \
   -d mysql:8.0
   ```

3. 稍等一会，从终端连入容器，并建立数据库

   ```bash
   docker exec -it lyl232fm_mysql bash
   ```

   在容器的终端登录mysql：

   ```bash
   mysql -uroot -p123456
   ```

   如果出现如下错误：

   ```
   ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock' (2)
   ```

   则说明容器还没启动完毕，请稍后重试。

   在mysql终端建立名为lyl232fm的数据库：

   ```sql
   CREATE DATABASE lyl232fm CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

 4. 将db_config.json调整为自己配置的内容：

    ```json
    {
      "mysql": {
        "host": "localhost",
        "user": "root",
        "password": "123456",
        "port": 3306
      }
    }
    ```

#### 将项目根目录加入系统路径(可选)

目的是可在任何地方执行lfm脚本

# 用户手册

## 概念

### 文件记录

文件记录对应着一个文件在目录里的状态数据，包括相对路径、MD5值等。

### 目录记录和管理记录

本程序假设所管理的文件夹有多份副本，所以本程序的目录其实是若干个文件记录的集合。而管理记录则是记录了一个目录的其中一个物理位置。

本程序就是利用数据库工具管理这些记录，通过比较本地的文件和数据库中的文件记录，来达到同步、备份、去重庞大复杂文件夹的目的。

## 初始化数据库（如果执行其他需要数据库的命令会自动执行）

```bash
lfm init_db [路径(可选)]
```

也可以指定可选参数，一个指向导出数据的文件夹路径，导出数据的操作可见下文中的"导出数据"。

## 新建一个目录记录

```bash
lfm mkdir 目录记录名称 目录描述
```

其中"目录记录名称"和"目录描述"都是必须的。注意"目录记录名称"不能重复。

## 新建一个管理记录

```bash
lfm manage 路径 目录记录名称 管理标记
```

这将新建一个对“目录记录名称”目录的管理记录。注意"管理标记"不能重复，它应该对应唯一一个物理文件夹，即"路径"所对应的文件夹。

并且开始对比"路径"下所有文件与数据库中"目录记录名称"下所有的文件记录。

若发现本地文件与文件记录不同（包括文件路径不同和文件内容不同），则会询问如何操作，基本上分为更新数据库或者将数据库中的记录同步到本地。

如果"路径"文件夹已经受管理，则其路径下会有`.lyl232fm`文件夹，此时可以简单使用命令：

```bash
lfm manage
```

来同步数据库与本地的文件记录。

## 文件查重

检查所有文件记录中是否有相同的文件记录。

```bash
lfm qrf
```

首先会检查没有md5的文件记录，并找出大小相同的组合，因为它们可能是相同的文件。然后询问用户是否计算这些文件记录的MD5值。如果计算MD5值，将会更新至数据库中。

接着检查数据库中所有有MD5值的文件记录，如果有大小和MD5值完全相同的记录，则认为它们是重复的，并将它们全部列出，逐一询问保留哪条文件记录。

这些操作只更新数据库，并不会真正删除文件。

查重结束后，可以在各个管理记录对应的物理路径下使用命令：

```bash
lfm manage
```

将查重后的文件记录更新到本地的文件夹下，需要删除的文件将会逐一询问。

## 查询所有目录

```bash
lfm ls [目录名字(可选)]
```

如果不输入目录名字，将输出所有被管理的目录，否则显示出该目录所有的管理记录。

## 查询目录下的文件记录

```bash
lfm fr [目录名字(可选)]
```

如果不输入目录名字，则会自动查找本目录下的.lyl232fm文件夹读取其目录名字，如果找不到目录记录则报错。输出文件记录的相对路径、大小和修改日期。

## 删除指定目录记录

```bash
lfm rm 目录名字
```

删除指定的目录记录，如果目录不为空（有关联的管理记录或者文件记录）无法删除，需要先删除相关记录。

## 删除指定管理记录

```bash
lfm cm 管理标签
```

删除指定的管理记录。

## 导出数据

```bash
lfm dump_db 路径
```

将数据库中的记录数据导出到指定的路径下，请确保该路径不存在，并且其父文件夹存在。导出的文件夹可以作为初始化数据库时的可选参数进行数据恢复。

## 删除数据库

【注意！】高危操作，将删除所有记录数据，必须指定一个输出路径将数据库导出，以保证可以恢复。如何处理导出的数据不在本程序的讨论范围内。

```bash
lfm clear_db
```

